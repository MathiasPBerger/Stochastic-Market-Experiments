\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{xcolor}
\newtheorem{theorem}{Theorem}
\newtheorem{proposition}{Proposition}
\newtheorem{definition}{Definition}
\newtheorem{corollary}{Corollary}
\newtheorem{lemma}{Lemma}
\newtheorem{assumption}{Assumption}

\title{Properties of Chance-Constrained Stochastic Electricity Markets}
\author{Mathias Berger}
\date{Spring 2022}

\begin{document}

\maketitle

\section{Introduction}

We analyse the properties of a chance-constrained stochastic market for energy and reserves involving stochastic wind power producers, flexible generators and inflexible electricity consumers. 

\section{Problem Statement}

\subsection{Preliminaries}

We consider four types of agents, namely flexible electricity generators, stochastic wind power producers, inflexible electricity consumers and a market operator, which we describe further below.

\textit{Wind Producers}: We consider $N \in \mathbb{N}$ stochastic wind producers. Although a forecast $\tilde{W}_i \in \mathbb{R}_+$ is available for the production of wind farm $i = 1, \ldots, N$, the actual output $\mathbf{p}_i^w(\boldsymbol{\omega}_i) \in \mathbb{R}_+$ may deviate from $\tilde{W}_i$ by some amount given by random variable $\boldsymbol{\omega}_i \in \Omega_i \subseteq \mathbb{R}$, such that $\mathbf{p}_i^w(\boldsymbol{\omega}_i) = \tilde{W}_i + \boldsymbol{\omega}_i$. Note that we use bold symbols to denote random variables. The first and second-order moments (i.e., the mean and variance) of the distribution of the forecast error $\boldsymbol{\omega}_i$ are denoted by $\mathbb{E}[\boldsymbol{\omega}_i] = \mu_i$ and $\mbox{Var}[\boldsymbol{\omega}_i] = \sigma_i^2$, respectively. The covariance between $\boldsymbol{\omega}_i$ and $\boldsymbol{\omega}_j$ is denoted by $\mbox{Cov}[\boldsymbol{\omega}_i, \boldsymbol{\omega}_j] = \kappa_{ij} = \rho_{ij} \sigma_i \sigma_j$, with $\rho_{ij}$ the Pearson correlation coefficient. For conciseness, we will use $\boldsymbol{\omega}^\top = \begin{pmatrix} \boldsymbol{\omega}_1, \ldots, \boldsymbol{\omega}_N \end{pmatrix}$ and denote the mean vector and covariance matrix as $\mu \in \mathbb{R}^N$ and $\Sigma \in \mathbb{R}^{N \times N}$, respectively. All agents are assumed to have access to the same amount of information about $\{\boldsymbol{\omega}_i\}_{\forall i}$ and $\{\mathbf{p}_i^w(\boldsymbol{\omega}_i)\}_{\forall i}$. Wind producers are assumed to have zero marginal cost, be paid for their forecast production and charged for the provision of reserves.

\textit{Flexible Generators}: We consider $K \in \mathbb{N}$ flexible generators. Each generator may produce electricity and contribute to the provision of reserves in the system. Hence, the actual power output $\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})$ is given by an affine control law. For generator $k$, this law can be expressed as $\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) = p_k - \sum_{i }\alpha_{ki} \boldsymbol{\omega}_i$, where $p_k$ denotes the scheduled power output and $\alpha_{ki}$ is the share of the forecast error of wind producer $i$ covered by generator $k$ through the reserve mechanism. It is assumed that generators are paid for their scheduled production $p_k$ (not their real-time production $\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})$) in the energy market and their contributions $\{\alpha_{ki}\}_{\forall i}$ to reserve procurement. Since the actual power output of generators directly depends on the uncertain wind production and only becomes known when $\{\boldsymbol{\omega}_i\}_{\forall i}$ are revealed, it must be ensured that power generation bounds are not exceeded. Chance (i.e., probabilistic) constraints can be used for this purpose, and $\epsilon_k$ denotes the tolerance for constraint violations (e.g., constraints may be violated $100 \times \epsilon_k \%$ of the time). Generator $k$ is assumed to have linear and quadratic marginal production cost components denoted by $c_k^L \in \mathbb{R}_+$ and $c_k^Q \in \mathbb{R}_+$, respectively.

\textit{Inflexible Consumers}: We consider a set of consumers with aggregate demand $D \in \mathbb{R}_+$, which is assumed inelastic and known with certainty.

\textit{Market Operator}: In an equilibrium problem, a market operator (also known as a \textit{social planner}) can be interpreted as an auctioneer seeking to identify prices for energy and reserves so that the markets for energy and reserves clear (akin to a Walras auctioneer \cite{Uzawa1960}). 

\section{Equilibrium Problem Formulation}

The stochastic electricity market can be modelled as a stochastic equilibrium problem where flexible generators seek to maximise their utility while being coupled through market clearing constraints. The different components of the equilibrium problem formulation are described in this section. 

\subsection{Flexible Generators}

We start by describing the stochastic optimisation problems faced by flexible generators, and recast them as deterministic optimisation problems.

\subsubsection{Stochastic Formulation}

We consider risk-neutral flexible generators (i.e., generators only care about the expected pay-off and not its variance). Thus, flexible generator $k$ seeks to maximise its expected pay-off subject to chance constraints on its power output:
\begin{align}
\underset{p_k, \{\alpha_{ki}\}_{\forall i}}{\max} \hspace{10pt} & \mathbb{E}[\lambda p_k + \sum_i \chi_i \alpha_{ki} - c_k^L \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) - c_k^Q (\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}))^2]\\
\mbox{s.t. } & \mathbb{P}[\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) \le \overline{p}_k] \ge 1 - \epsilon_k,\\
& \mathbb{P}[0 \le \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})] \ge 1 - \epsilon_k,\\
&p_k \in \mathbb{R}, 0 \le \alpha_{ki} \le 1, \forall i.
\end{align}
Note that electricity and reserve prices, which are denoted by $\lambda$ and $\{\chi_i\}_{\forall i}$, respectively, are treated as parameters by each producer $k$.
\subsubsection{Deterministic Equivalent Formulation}

The stochastic expected profit maximisation problem faced by producer $k$ can be recast as an equivalent deterministic program as follows. We start by re-formulating the objective and focus on chance constraints next.

\paragraph{Expected Pay-Off} By linearity of the expectation operator, the expected pay-off can be re-written as
\begin{align*}
\Pi_k(p_k, \{\alpha_{ki}\}_{\forall i}) &= \mathbb{E}\Big[\lambda p_k + \sum_i \chi_i \alpha_{ki} - c_k^L \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) - c_k^Q (\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}))^2\Big]\\
&= \mathbb{E}\big[\lambda p_k\big] + \mathbb{E}\Big[\sum_i \chi_i \alpha_{ki}\Big] - \mathbb{E}\big[c_k^L \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})\big] - \mathbb{E}\big[c_k^Q (\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}))^2\big].
\end{align*}
We focus on each term separately and obtain
\begin{align*}
\mathbb{E}[\lambda p_k] =& \lambda p_k,\\
\mathbb{E}\Big[\sum_i \chi_i \alpha_{ki}\Big] =& \sum_i \chi_i \alpha_{ki},\\
\mathbb{E}[c_k^L \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})] &= \mathbb{E}\Big[c_k (p_k - \sum_i \alpha_{ki} \boldsymbol{\omega}_i)\Big]\\
=& c_k^L\Big(p_k - \sum_i \alpha_{ki} \mu_i\Big),\\
\mathbb{E}[c_k^Q (\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}))^2] &= \mathbb{E}[c_k^Q (p_k - \sum_i \alpha_{ki} \boldsymbol{\omega}_i)^2]\\
=& \mathbb{E}\Big[c_k^Q \big(p_k^2 - \sum_i 2 \boldsymbol{\omega}_i \alpha_{ki} p_k + \sum_i \sum_{j \ne i} \alpha_{ki} \alpha_{kj}  \boldsymbol{\omega}_i  \boldsymbol{\omega}_j + \sum_i \alpha_{ki}^2 \boldsymbol{\omega}_i^2\big)\Big]\\
=& c_k^Q \Big(p_k^2 - \sum_i 2\mu_i \alpha_{ki} p_k + \sum_i \sum_{j \ne i} \alpha_{ki} \alpha_{kj}  \mathbb{E}[\boldsymbol{\omega}_i  \boldsymbol{\omega}_j] + \sum_i \alpha_{ki}^2 \mathbb{E}[\boldsymbol{\omega}_i^2]\Big)\\
=& c_k^Q \Big(p_k^2 - \sum_i 2\mu_i \alpha_{ki} p_k + \sum_i \sum_{j \ne i} \alpha_{ki} \alpha_{kj}  (\mbox{Cov}[\boldsymbol{\omega}_i, \boldsymbol{\omega}_j] + \mu_i \mu_j)\\
 &+ \sum_i \alpha_{ki}^2 (\mbox{Var}[\boldsymbol{\omega}_i] + \mathbb{E}[\boldsymbol{\omega}_i]^2)\Big)\\
=& c_k^Q \Big(p_k^2 - \sum_i 2\mu_i \alpha_{ki} p_k + \sum_i \sum_{j \ne i} \alpha_{ki} \alpha_{kj}  (\kappa_{ij} + \mu_i \mu_j) + \sum_i \alpha_{ki}^2 (\sigma_i^2 + \mu_i^2)\Big)\\
=& c_k^Q \Big((p_k - \sum_i \alpha_{ki} \mu_i)^2 + \sum_i \sum_{j \ne i} \alpha_{ki} \alpha_{kj}  \kappa_{ij} + \sum_i \alpha_{ki}^2 \sigma_i^2 \Big).
\end{align*}
Thus, the expected pay-off of producer $k$ becomes
\begin{align*}
\Pi_k(p_k, \{\alpha_{ki}\}_{\forall i}) =& \lambda p_k + \sum_i \chi_i \alpha_{ki} - c_k^L\Big(p_k - \sum_i \alpha_{ki} \mu_i\Big)\\
&- c_k^Q \Big(\big(p_k - \sum_i \alpha_{ki} \mu_i\big)^2 + \sum_i \sum_{j \ne i} \alpha_{ki} \alpha_{kj}  \kappa_{ij} + \sum_i \alpha_{ki}^2 \sigma_i^2\Big).
\end{align*}
The first term represents the expected revenue accruing from the sale of electricity. The second term is the expected revenue from the provision of reserves. The third term represents the expected linear cost component. The last term represents the expected quadratic cost component. Note that the quadratic cost component depends on the expected production level, the variance of the forecast errors as well as their covariances. For notational convenience, let $\mu = \begin{pmatrix} \mu_1, \ldots, \mu_N \end{pmatrix}^\top$, $\alpha_k = \begin{pmatrix} \alpha_{k1}, \ldots, \alpha_{kN} \end{pmatrix}^\top$, $\chi = \begin{pmatrix} \chi_1, \ldots, \chi_N \end{pmatrix}^\top$ and let $\Sigma \in \mathbb{R}_+^{N \times N}$ be the covariance matrix of wind forecast errors. Then, the expected pay-off of producer $k$ can be compactly expressed as
\begin{align*}
\Pi_k(p_k, \alpha_k) =& \lambda p_k + \alpha_k^\top \chi - c_k^L\big(p_k - \alpha_k^\top \mu\big) - c_k^Q \Big(\big(p_k - \alpha_{k}^\top \mu \big)^2 + \alpha_k^\top \Sigma \alpha_k\Big),
\end{align*}
which is a concave function of its variables. Note that the function is strictly concave if $c_k^Q > 0$ and $\Sigma \succ 0$. In particular, this will be the case if all forecast errors are independent or no forecast error can be expressed as an exact linear function of other forecast errors.

\paragraph{Chance Constraints} Chance constraints imposed on generation levels should also be re-formulated to obtain a deterministic mathematical program. For now, we assume that $\boldsymbol{\omega} \in \mathbb{R}^N$ follows a multivariate normal distribution with mean vector $\mu \in \mathbb{R}^N$ and covariance matrix $\Sigma \in \mathbb{R}^{N \times N}$. For some risk level $\epsilon_k \in (0, 0.5]$, we then have
\begin{align*}
&\mathbb{P}[\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) \le \overline{p}_k] \ge 1 - \epsilon_k\\
\Leftrightarrow &\mathbb{P}\Big[p_k - \sum_i \alpha_{ki} \boldsymbol{\omega}_i \le \overline{p}_k\Big] \ge 1 - \epsilon_k\\
\Leftrightarrow &\mathbb{P}\Big[\frac{- \sum_i \alpha_{ki} \boldsymbol{\omega}_i + \alpha_k^\top \mu}{\sqrt{\alpha_k^\top \Sigma \alpha_k}} \le \frac{\overline{p}_k - p_k + \alpha_k^\top \mu}{\sqrt{\alpha_k^\top \Sigma \alpha_k}}\Big] \ge 1 - \epsilon_k\\
\Leftrightarrow & \Phi\bigg(\frac{\overline{p}_k - p_k + \alpha_k^\top \mu}{\sqrt{\alpha_k^\top \Sigma \alpha_k}}\bigg)\ge1-\epsilon_k\\
\Leftrightarrow &\frac{\overline{p}_k - p_k + \alpha_k^\top \mu}{\sqrt{\alpha_k^\top \Sigma \alpha_k}} \ge \Phi^{-1}(1 - \epsilon_k)\\
\Leftrightarrow &p_k \le \overline{p}_k + \alpha_k^\top \mu - ||\alpha_k||_{\Sigma} \Phi^{-1}(1 - \epsilon_k),
\end{align*}
where $\Phi:\mathbb{R} \rightarrow (0, 1)$ is the cumulative distribution function and $\Phi^{-1}: (0, 1) \rightarrow \mathbb{R}$ is the quantile function of the standard normal distribution. We just proved the following result.

\begin{proposition}\label{ND_SOCP_CC}
For some risk level $0 < \epsilon_k \le 0.5$, the chance constraint
\begin{equation*}
\mathbb{P}\Big[p_k - \sum_i \alpha_{ki} \boldsymbol{\omega}_i \le \overline{p}_k\Big] \ge 1 - \epsilon_k,
\end{equation*}
where $\boldsymbol{\omega} \in \mathbb{R}^N$ follows a multivariate normal distribution with mean vector $\mu \in \mathbb{R}^N$ and covariance matrix $\Sigma \in \mathbb{R}^{N \times N}$ is equivalent to the deterministic second-order cone constraint
\begin{equation*}
p_k \le \overline{p}_k + \alpha_k^\top \mu - ||\alpha_k||_{\Sigma} \Phi^{-1}(1 - \epsilon_k),
\end{equation*}
with $\Phi^{-1}$ the quantile function of the standard normal distribution.
\end{proposition}

In the particular case that $\boldsymbol{\omega}$ is a scalar random variable, the second-order cone constraint reduces to a linear inequality constraint, as observed in \cite{Dvorkin2020}. Note that similar results hold for linear inequality constraints involving random vectors that follow radial distributions \cite{Calafiore2006}. In addition, similar convex formulations were derived in the distributionally-robust setting by Calafiore and El Ghaoui \cite{Calafiore2006}.

\begin{proposition}\label{DR_SOCP_CC}
For any risk level $0 < \epsilon_k < 1$, the distributionally-robust chance constraint
\begin{equation*}
\inf_{\mathbb{P} \in \Psi} \mathbb{P}\Big[p_k - \sum_i \alpha_{ki} \boldsymbol{\omega}_i \le \overline{p}_k\Big] \ge 1 - \epsilon_k,
\end{equation*}
where $\Psi = \{\mathbb{P}: \mathbb{E}[\boldsymbol{\omega}] = \mu, \mbox{Var}[\boldsymbol{\omega}] = \Sigma\}$ is the family of probability distributions with first and second-order moments $\mu$ and $\Sigma$, is equivalent to the second-order cone constraint
\begin{equation*}
p_k - \alpha_k^\top \mu \le \overline{p}_k - \sqrt{\frac{1-\epsilon_k}{\epsilon_k}} ||\alpha_k||_{\Sigma}.
\end{equation*}
\end{proposition}
%\textcolor{orange}{In other settings, distributionally-robust chance constraints may be recast as second-order cone constraints \cite{Xie2018}}.

Applying Proposition \ref{ND_SOCP_CC} (or Proposition \ref{DR_SOCP_CC}) to the second chance constraint yields
\begin{align*}
&\mathbb{P}[0 \le \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})] \ge 1 - \epsilon_k\\
\Leftrightarrow & \alpha_k^\top \mu + ||\alpha_k||_{\Sigma} \phi_k \le p_k,
\end{align*}
where $\phi_k = \Phi^{-1}(1 - \epsilon_k)$ under and the assumption that the forecast errors follow normal distribution and $\phi_k = \sqrt{(1-\epsilon_k)/\epsilon_k}$ in the distributionally robust setting.

\paragraph{Deterministic Formulation} The deterministic equivalent of the stochastic profit-maximisation problem of producer $k$ reads
\begin{align}
\underset{p_k, \{\alpha_{ki}\}_{\forall i}}{\max} \hspace{10pt} & \lambda p_k + \alpha_k^\top \chi - c_k^L\big(p_k - \alpha_k^\top \mu\big) - c_k^Q \Big(\big(p_k - \alpha_{k}^\top \mu \big)^2 + \alpha_k^\top \Sigma \alpha_k\Big)\\
\mbox{s.t. } & p_k \le \overline{p}_k + \alpha_k^\top \mu - ||\alpha_k||_{\Sigma} \phi_k, \hspace{25pt} (\overline{\nu}_k)\\
& \alpha_k^\top \mu + ||\alpha_k||_{\Sigma} \phi_k \le p_k, \hspace{48pt}(\underline{\nu}_k)\\
& 0 \le \alpha_{ki} \le 1, \forall i,\\
&p_k \in \mathbb{R},
\end{align}
which is a quadratically-constrained (concave) quadratic program.
\subsection{Market Operator}

\subsubsection{Stochastic Formulation}

The market operator seeks to clear the energy market and procure enough reserves to cover any forecast error,
\begin{align}
& \sum_k \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) + \sum_i \mathbf{p}_i^w(\boldsymbol{\omega}_i) = D,\\
& \sum_{k} \alpha_{ki} = 1, \forall i.
\end{align}

\subsubsection{Deterministic Equivalent Formulation}

Simply substituting the affine control law of flexible generators yields
\begin{align}
& \sum_k p_k + \sum_i \tilde{W}_i = D, \hspace{10pt} (\lambda)\\
& \sum_k \alpha_{ki} = 1, \forall i, \hspace{35pt} (\chi_i)
\end{align}
where electricity and reserve prices are obtained as the dual variables of the power balance and reserve allocation constraints.
\subsection{Wind Producers}

Wind producers are price takers and do not control their output (i.e., no spillage is allowed), and therefore do not solve any optimisation problem \textit{per se}. It is assumed that wind producers are paid for their forecast production and are charged for the uncertainty that they introduce in the system. More precisely, this charge is proportional to the dual variable of the reserve allocation constraint associated with a given wind producer. Their expected revenue can thus be computed as $R = \mathbb{E}[\lambda \tilde{W}_i - \chi_i] = \lambda \tilde{W}_i - \chi_i$.

\subsection{Electricity Consumers}

The demand is assumed to be inelastic and electricity consumers do not solve any optimisation problem either. Their expected cost can be calculated as $P = \mathbb{E}[\lambda D] = \lambda D$.

\section{Market Clearing Problem Formulation}

This section describes a stochastic market clearing problem that can be solved by a market operator in order to identify prices for energy and reserves, schedule generators and allocate reserves in a cost-efficient way. 

\subsection{Stochastic Formulation}
Under the assumption that the market operator is risk-neutral, the stochastic market clearing problem can be formulated as

\begin{align}
\underset{\{p_k, \{\alpha_{ki}\}_{\forall i}\}_{\forall k}}{\min} \hspace{10pt} & \mathbb{E}\Big[\sum_k \big(c_k^L \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) + c_k^Q \big(\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})\big)^2\big)\Big]\\
\mbox{s.t. } & \mathbb{P}[\mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) \le \overline{p}_k] \ge 1 - \epsilon_k, \mbox{ }\forall k,\\
& \mathbb{P}[0 \le \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i})] \ge 1 - \epsilon_k, \mbox{ }\forall k,\\
& \sum_k \mathbf{p}_k^g(\{\boldsymbol{\omega}_i\}_{\forall i}) + \sum_i \mathbf{p}_i^w(\boldsymbol{\omega}_i) = D,\\
& \sum_k \alpha_{ki} = 1, \forall i,\\
& 0 \le \alpha_{ki} \le 1, \forall k, \forall i,\\
& p_k \in \mathbb{R}, \forall k.
\end{align}

\subsection{Deterministic Equivalent Formulation}
Using techniques introduced earlier yields the following equivalent deterministic formulation of the market clearing problem:
\begin{align}
\underset{\{p_k, \alpha_k\}_{\forall k}}{\min} \hspace{10pt} & \sum_k \Big(c_k^L\big(p_k - \alpha_k^\top \mu\big) + c_k^Q \Big(\big(p_k - \alpha_{k}^\top \mu \big)^2 + \alpha_k^\top \Sigma \alpha_k\Big)\Big)\\
\mbox{s.t. } & p_k - \alpha_k^\top \mu\le \overline{p}_k - ||\alpha_k||_{\Sigma} \phi_k, \mbox{ }\forall k, \hspace{15pt}(\overline{\nu}_k)\\
& ||\alpha_k||_{\Sigma} \phi_k \le p_k - \alpha_k^\top \mu, \mbox{ }\forall k, \hspace{37pt}(\underline{\nu}_k)\\
& \sum_k p_k + \sum_i \tilde{W}_i = D, \hspace{70pt} (\lambda)\\
& \sum_k \alpha_{ki} = 1, \forall i, \hspace{95pt} (\chi_i)\\
& 0 \le \alpha_{ki} \le 1, \forall k, \forall i,\\
& p_k \in \mathbb{R}, \forall k,
\end{align}
where the dual variables of the energy balance and reserve allocation constraints are used to set energy and reserve prices, respectively. Note that computing expectations and treating chance constraints in the problem solved by the market operator in the same way as in the problem of a market participant is only possible under the assumption that they all share the same information about $\{\boldsymbol{\omega}_i\}_{\forall i}$. This assumption is implicit in the next sections. In particular, it is a pre-requisite for the pricing scheme of the market operator to support a competitive equilibrium (since the complementarity problems stemming from the equilibrium and market clearing approaches would otherwise be different). This topic is also discussed in the context of a stochastic programming-based market design by Dvorkin et al. \cite{DvorkinV2019}.

\section{Market Properties}

We analyse four key properties of the proposed stochastic market design, namely whether it supports a \textit{competitive equilibrium}, guarantees \textit{cost recovery} for flexible generators, \textit{revenue adequacy} for the market operator, and is \textit{incentive compatible}.

\begin{assumption}\label{StrictConvexity}
We assume throughout this section that $c_k > 0, \bar{p}_k > 0, \phi_k \ge 0, \forall k,$ and $\Sigma \succ 0$.
\end{assumption}

Note that selecting $\epsilon_k \in (0, 0.5]$ will guarantee that $\phi_k \ge 0$ if forecast errors are assumed to follow normal distributions. On the other hand, $\phi_k > 0$ always holds for $\epsilon_k \in (0, 1)$ in the distributionally robust setting.

\begin{definition}
(Competitive Equilibrium) A competitive equilibrium for the stochastic market is a set of prices $\{\lambda^*, \{\chi_i^*\}_{\forall i}\}$ and decisions $\{p_k^*, \{\alpha_{ki}^*\}_{\forall i}\}_{\forall k}$ that\vspace{-5pt}
\begin{enumerate}
\item clear the markets: $\sum_k p_k^* + \sum_i \tilde{W}_i = D$ and $\sum_k \alpha_{ki}^* = 1, \forall i$\vspace{-5pt}
\item maximise the expected pay-off of flexible generators
\end{enumerate}
\end{definition}

\begin{lemma}\label{ExpectedPayOff}
Let $V_k^*$ denote the expected pay-off of flexible generator $k$ under prices and decisions computed by the market operator. Then,
\begin{equation*}
V_k^* = c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)^2 + c_k^Q (\alpha_k^*)^\top \Sigma \alpha_k^* + \overline{\nu}_k^* \overline{p}_k.
\end{equation*}
\end{lemma}
\begin{proof}
We successively have
\begin{align*}
    V_k^* =& \lambda^*p_k^* + (\alpha_k^*)^\top\chi^* - c_k^L(p_k^* - (\alpha_k^*)^\top \mu) - c_k^Q\big((p_k^* - (\alpha_k^*)^\top \mu)^2 + (\alpha_k^*)^\top\Sigma \alpha_k^*\big) \\
    =& \lambda^*p_k^* + (\alpha_k^*)^\top\chi^* - c_k^L(p_k^* - (\alpha_k^*)^\top \mu) - c_k^Q\big((p_k^* - (\alpha_k^*)^\top \mu)^2 + (\alpha_k^*)^\top\Sigma \alpha_k^*\big)\\
   &+ \underline{\nu}_k^*(p_k^* - (\alpha_k^*)^\top \mu - ||\alpha_k^*||_{\Sigma} \phi_k) + \overline{\nu}_k^* (-p_k^* + \overline{p}_k + (\alpha_k^*)^\top \mu - ||\alpha_k^*||_{\Sigma} \phi_k)\\
=& p_k^*\big(\lambda^* - c_k^L + \underline{\nu}_k^* - \overline{\nu}_k^*\big) - c_k^Q\big(p_k^* - (\alpha_k^*)^\top \mu\big)^2 + \overline{\nu}_k^* \overline{p}_k - \phi_k||\alpha_k^*||_{\Sigma} (\underline{\nu}_k^* + \overline{\nu}_k^*)\\
    &+ \sum_i \alpha_{ki}^*\big(\chi_i^* + c_k^L \mu_i - \underline{\nu}_k^* \mu_i + \overline{\nu}_k^* \mu_i\big) - c_k^Q (\alpha_k^*)^\top\Sigma \alpha_k^* \\
    =& p_k^*\big(2c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)\big) - c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)^2 + \overline{\nu}_k^* \overline{p}_k - \phi_k||\alpha_k^*||_{\Sigma} (\underline{\nu}_k^* + \overline{\nu}_k^*)\\ 
    &+ \sum_i \alpha_{ki}^*\Big(2c_k^Q\big(\alpha_{ki}^*\mu_i^2 - p_k^* \mu_i - \sum_{j \ne i} \alpha_{kj}^* \mu_i \mu_j + \sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}^*\big) \\
    &+ \phi_k \frac{\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}^*}{||\alpha_k^*||_\Sigma}(\underline{\nu}_k^* +\overline{\nu}_k^*)\Big) - c_k^Q (\alpha_k^*)^\top\Sigma \alpha_k^*\\
    =& 2c_k^Q\big((p_k^*)^2 - p_k^*(\alpha_k^*)^\top \mu\big) - c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)^2 + \overline{\nu}_k^* \overline{p}_k - \phi_k||\alpha_k^*||_{\Sigma} (\underline{\nu}_k^* + \overline{\nu}_k^*)\\ 
    &+ 2c_k^Q \sum_i \alpha_{ki}^*\big(\alpha_{ki}^*\mu_i^2 - p_k^* \mu_i - \sum_{j \ne i} \alpha_{kj}^* \mu_i \mu_j)  + 2c_k^Q \sum_i \alpha_{ki}^* \big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}^*\big)\\
    &+ \phi_k\frac{\underline{\nu}_k^* +\overline{\nu}_k^*}{||\alpha_k^*||_\Sigma} \sum_i \alpha_{ki}^*\big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}^*\big) - c_k^Q (\alpha_k^*)^\top\Sigma \alpha_k^*\\
    =& 2c_k^Q\big(p_k^* - (\alpha_k^*)^\top \mu\big)^2 - c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)^2 + \overline{\nu}_k^* \overline{p}_k - \phi_k||\alpha_k^*||_{\Sigma} (\underline{\nu}_k^* + \overline{\nu}_k^*)\\ 
    &+ 2c_k^Q (\alpha_{k}^*)^\top \Sigma \alpha_k^* + \phi_k\frac{\underline{\nu}_k^* +\overline{\nu}_k^*}{||\alpha_k^*||_\Sigma} ||\alpha_k^*||_\Sigma^2 - c_k^Q (\alpha_k^*)^\top\Sigma \alpha_k^*\\
    =& c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)^2 + c_k^Q (\alpha_k^*)^\top \Sigma \alpha_k^* + \overline{\nu}_k^* \overline{p}_k.
\end{align*}
The first line uses the definition of the objective function of flexible generator $k$ and the second line results from the fact that the two new terms are equal to zero (complementary slackness). The third line is obtained by re-arranging terms. The fourth line follows from the stationarity of the Lagrangian with respect to $p_k$ and $\alpha_k$, respectively (see KKT conditions in Appendix A). The fifth line follows from re-arranging terms. The sixth line is obtained by noting that
\begin{equation*}
||\alpha_k^*||_\Sigma^2 = (\alpha_k^*)^\top \Sigma \alpha_k^* = \sum_i \alpha_{ki}^*\big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}^*\big).
\end{equation*}
The last line is obtained by re-arranging and cancelling terms out.
\end{proof}

\begin{proposition}
(\textcolor{green}{Competitive Equilibrium}) The stochastic market clearing problem produces prices and decisions maximising the expected pay-off of each flexible generator and supporting a competitive equilibrium from which they have no incentive to deviate.
\end{proposition}
\begin{proof}
The proof consists in showing that the expected pay-off of flexible generator $k$ (given in Lemma \ref{ExpectedPayOff}) is optimal (i.e., decisions and prices computed by the market operator maximise the expected pay-off of flexible generator $k$).

Let $\{p_k^\star, \alpha_k^\star\}$ denote an optimal solution of the problem faced by producer $k$ under prices $\{\lambda^*, \chi^*\}$, and let $V_k^\star$ denote the corresponding objective. We essentially seek to show that $V_k^\star \le V_k^*$. We successively find
\begin{align*}
    V_k^\star =& \lambda^*p_k^\star + (\alpha_k^\star)^\top \chi^* - c_k^L(p_k^\star - (\alpha_k^\star)^\top \mu) - c_k^Q\big((p_k^\star - (\alpha_k^\star)^\top \mu)^2 + (\alpha_k^\star)^\top \Sigma \alpha_k^\star\big)\\
    \le& \lambda^*p_k^\star + (\alpha_k^\star)^\top \chi^* - c_k^L(p_k^\star - (\alpha_k^\star)^\top \mu) - c_k^Q\big((p_k^\star - (\alpha_k^\star)^\top \mu)^2 + (\alpha_k^\star)^\top \Sigma \alpha_k^\star\big)\\
    &+ \underline{\nu}_k^*(p_k^\star - (\alpha_k^\star)^\top \mu - ||\alpha_k^\star||_{\Sigma} \phi_k) + \overline{\nu}_k^* (-p_k^\star + \overline{p}_k + (\alpha_k^\star)^\top \mu - ||\alpha_k^\star||_{\Sigma} \phi_k)\\
    =& p_k^\star\big(\lambda^* - c_k^L + \underline{\nu}_k^* - \overline{\nu}_k^*\big) - c_k^Q(p_k^\star - (\alpha_k^\star)^\top \mu)^2 + \overline{\nu}_k^* \overline{p}_k - \phi_k ||\alpha_k^\star||_\Sigma (\underline{\nu}_k^* + \overline{\nu}_k^*)\\
    &+ \sum_i \alpha_{ki}^\star\big(\chi_i^* + c_k^L \mu_i - \underline{\nu}_k^* \mu_i + \overline{\nu}_k^* \mu_i\big) - c_k^Q (\alpha_k^\star)^\top \Sigma \alpha_k^\star \\
   =& p_k^\star\big(2c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)\big) - c_k^Q(p_k^\star - (\alpha_k^\star)^\top \mu)^2 + \overline{\nu}_k^* \overline{p}_k - \phi_k ||\alpha_k^\star||_\Sigma (\underline{\nu}_k^* + \overline{\nu}_k^*)\\    
   &+ \sum_i \alpha_{ki}^\star \Big(2c_k^Q\big(- p_k^* \mu_i + \alpha_{ki}^*\mu_i^2 + \sum_{j \ne i} \alpha_{kj}^* \mu_i \mu_j + \sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}^*\big) \\
    &+ \phi_k \frac{\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}^*}{||\alpha_k^*||_\Sigma}(\underline{\nu}_k^* +\overline{\nu}_k^*)\Big) - c_k^Q (\alpha_k^\star)^\top\Sigma \alpha_k^\star,
\end{align*}
where the second line follows from the fact that $\underline{\nu}_k^* \ge 0$ and $\overline{\nu}_k^* \ge 0$ (dual feasibility for market clearing solution), while the terms in parentheses multiplying them are non-negative (primal feasibility of ($p_k^\star, \alpha_k^\star$) for producer $k$). The third line is obtained by re-arranging terms and the fourth line follows from the stationarity of the Lagrangian of the market clearing problem with respect to $p_k$ and $\alpha_k$ (see KKT conditions in Appendix A). Now, let $f:\mathbb{R}^{N+1} \rightarrow \mathbb{R}$ be such that
\begin{align*}
f(x, y) =& x \big(2c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)\big) - c_k^Q(x - y^\top \mu)^2 + \overline{\nu}_k^* \overline{p}_k - \phi_k ||y||_\Sigma (\underline{\nu}_k^* + \overline{\nu}_k^*)\\ 
    &+ y^T \Big(2c_k^Q\big(- p_k^* \mu + M \alpha_k^* + \Sigma \alpha_k^*\big) + \frac{\phi_k}{||\alpha_k^*||_\Sigma}(\underline{\nu}_k^* +\overline{\nu}_k^*) \Sigma \alpha_k^*\Big) - c_k^Q y^T \Sigma y,
\end{align*}
where $M \in \mathbb{R}^{N \times N}$ is the rank-one matrix $M = \mu \mu^\top$.
We first note that
\begin{align*}
V_k^\star \le f(p_k^\star, \alpha_k^\star),
\end{align*} 
and
\begin{equation*}
f(p_k^*, \alpha_k^*) = V_k^*,
\end{equation*}
which directly follows from Lemma \ref{ExpectedPayOff}. We now seek to show that $f(p_k^\star, \alpha_k^\star) \le f(p_k^*, \alpha_k^*)$. To achieve this, we proceed in two steps. First, we check that $(x, y) = (p_k^*, \alpha_k^*)$ is a stationary point of $f$. Then, we check that it also corresponds to a maximum of $f$ by studying the properties of its Hessian matrix. We first compute
\begin{align*}
\frac{\partial f}{\partial x} =& 2c_k^Q(p_k^* - (\alpha_k^*)^\top\mu) - 2 c_k^Q x + 2c_k^Q y^\top \mu,\\
\frac{\partial f}{\partial y} =& - 2c_k^Q (y^\top \mu) \mu + 2 c_k^Q x \mu - \frac{\phi_k}{||y||_\Sigma} (\underline{\nu}_k^* + \overline{\nu}_k^*) \Sigma y - 2c_k^Q \Sigma y\\
&+ \Big(2c_k^Q\big(M \alpha_k^* - p_k^* \mu + \Sigma \alpha_k^*\big) + \frac{\phi_k}{||\alpha_k^*||_\Sigma}(\underline{\nu}_k^* +\overline{\nu}_k^*) \Sigma \alpha_k^*\Big).
\end{align*}
It is clear that setting $(x, y) = (p_k^*, \alpha_k^*)$ cancels the partial derivative of $f$ with respect to $x$. To see that it also cancels the partial derivatives with respect to each entry of $y$, it suffices to note that $\big((\alpha_k^*)^\top \mu\big)\mu = M\alpha_k^*$. It is straightforward to see that all other terms cancel each other out. We then derive an expression for the Hessian
\begin{equation*}
H(x, y) = \begin{pmatrix} \frac{\partial^2 f}{\partial x^2} & \frac{\partial^2 f}{\partial x \partial y} \\ \frac{\partial^2 f}{\partial y \partial x} & \frac{\partial^2 f}{\partial y^2}\end{pmatrix},
\end{equation*}
where
\begin{align*}
\frac{\partial^2 f}{\partial x^2} &= - 2c_k^Q,\\
\frac{\partial^2 f}{\partial x \partial y} &= 2 c_k^Q \mu^\top,\\
\frac{\partial^2 f}{\partial y \partial x} &= 2 c_k^Q \mu,\\
\frac{\partial^2 f}{\partial y^2} &= -2 c_k^Q M - \phi_k(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big(||y||_\Sigma^{-1} \Sigma - ||y||_\Sigma^{-3} \Sigma y(\Sigma y)^\top\Big) - 2c_k^Q \Sigma.
\end{align*}
We note that $-\partial^2 f/\partial y^2$ is positive definite. Indeed, i) $c_k^Q > 0$, ii) $M$ is a rank-one positive semi-definite matrix, iii) the matrix expression in parentheses is positive semi-definite since it is the Hessian of a weighted 2-norm (which is a convex function), $\phi_k \ge 0$ for $0 < \epsilon_k \le 0.5$ and $\underline{\nu}_k \ge 0$, $\overline{\nu}_k \ge 0$ (dual feasibility), iv) $\Sigma$ is positive definite. To guarantee that $(x, y) = (p_k^*, \alpha_k^*)$ is indeed a maximum of $f$, we must show that $-H(x, y)/2c_k^Q$ is positive definite. We start by re-writing it as
\begin{align*}
\hat{H}(y) = -\frac{H(x, y)}{2c_k^Q} &= \begin{pmatrix} 1 & 0^\top \\ 0 & M + g(y) + \Sigma\end{pmatrix} + \begin{pmatrix} 0 & -\mu^\top \\ -\mu & 0\end{pmatrix} = \Lambda + \Gamma,
\end{align*} 
where
\begin{equation*}
g(y) = \frac{\phi_k}{2 c_k^Q}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big(||y||_\Sigma^{-1} \Sigma - ||y||_\Sigma^{-3} \Sigma y(\Sigma y)^\top\Big).
\end{equation*}
Since $M + g(y) + \Sigma$ is positive definite, applying Sylvester's criterion suffices to show that $\Lambda$ is positive definite. On the other hand, $\Gamma$ is indefinite, as can be seen from its characteristic polynomial
\begin{equation*}
\mbox{det}(\Gamma - \nu I) = \nu^{N-1}\Big(\nu^2 - \sum_{i} \mu_i^2 \Big) = 0.
\end{equation*}
Let $\nu^- = -\sqrt{\sum_{i} \mu_i^2}$ denote the (only) negative eigenvalue of $\Gamma$. Then, for $\hat{H}$ to be positive definite, we need to check that
\begin{equation*}
z^\top \hat{H}(y) z > 0, \forall z, \forall y.
\end{equation*}
In particular, this inequality should hold for the eigenvector of $\Gamma$ corresponding to its negative eigenvalue, which is the only situation in which this inequality may be violated (since $\Lambda$ is positive definite and all other eigenvalues of $\Gamma$ are either positive or equal to $0$). Let $z^- \in \mathbb{R}^{N+1}$ denote this (normed) eigenvector. It is easy to check that
\begin{equation*}
z^- = \frac{1}{\sqrt{2}}\begin{pmatrix} 1 & \frac{\mu_1}{\sqrt{\sum_i \mu_i^2}} & \ldots & \frac{\mu_N}{\sqrt{\sum_i \mu_i^2}}\end{pmatrix}^\top.
\end{equation*}
In addition, let $z_N^- \in \mathbb{R}^N$ denote the vector obtained by keeping the last $N$ entries of $z^-$. Then, positive definiteness of $\hat{H}$ is guaranteed if
\begin{equation*}
(z^-)^\top \hat{H} z^- = (z^-)^\top\big(\Lambda + \Gamma\big) z^- = \Big(\frac{1}{2} + (z_N^-)^\top\big(M + g(y) + \Sigma\big)z_N^-\Big) + \nu^- > 0, \forall y.
\end{equation*}
In particular, this inequality should hold for all $y$ in $\arg \min_y (z_N^-)^\top g(y) z_N^-$. Since $g(y)$ is a positive semi-definite matrix for any $y$, it is easy to see from its definition that $(z_N^-)^\top g(z_N^-) z_N^- = 0$ and $y = z_N^-$ thus minimises the quadratic form. Hence, the condition to fulfil for $\hat{H}$ to be positive definite becomes
\begin{equation*}
\frac{1}{2} + (z_N^-)^\top\big(M + \Sigma\big)z_N^- + \nu^- > 0.
\end{equation*}
To check that this condition is indeed satisfied, we note that
\begin{align*}
(z_N^-)^\top M z_N^- &= \frac{1}{2}\begin{pmatrix} \frac{\mu_1}{\sqrt{\sum_i \mu_i^2}} & \ldots & \frac{\mu_N}{\sqrt{\sum_i \mu_i^2}}\end{pmatrix} \begin{pmatrix} \mu_1^2 & \ldots & \mu_1 \mu_N \\ \vdots & \ddots & \vdots \\ \mu_N \mu_1 & \ldots & \mu_N^2 \end{pmatrix} \begin{pmatrix} \frac{\mu_1}{\sqrt{\sum_i \mu_i^2}} \\ \ldots \\ \frac{\mu_N}{\sqrt{\sum_i \mu_i^2}}\end{pmatrix}\\
&= \frac{1}{2} \begin{pmatrix} \frac{\mu_1}{\sqrt{\sum_i \mu_i^2}} & \ldots & \frac{\mu_N}{\sqrt{\sum_i \mu_i^2}}\end{pmatrix} \begin{pmatrix} \mu_1 \sqrt{\sum_i \mu_i^2} \\ \ldots \\ \mu_N \sqrt{\sum_i \mu_i^2} \end{pmatrix}\\
&= \frac{1}{2} \sum_i \mu_i^2.
\end{align*}
Now, let $\bar{\nu} = \sqrt{\sum_i \mu_i^2}$ and $(z_N^-)^\top \Sigma z_N^- = \epsilon > 0$ (since $\Sigma$ is positive definite). Then, the condition for positive definiteness of $\hat{H}$ becomes
\begin{equation*}
\frac{1}{2} \bar{\nu}^2 - \bar{\nu} + \frac{1}{2} + \epsilon > 0.
\end{equation*}
It is straightforward to check that $\bar{\nu} = 1$ minimises the function on the left-hand side and its minimum is equal to $\epsilon > 0$, such that the condition for positive definiteness of $\hat{H}$ is always satisfied. In other words, $-H$ is positive definite and the Hessian matrix $H$ is negative definite. In turn, this implies that $(x, y) = (p_k^*, \alpha_k^*)$ is a maximum of $f$. Thus, $f(x, y) \le f(p_k^*, \alpha_k^*), \forall (x, y),$ and in particular $ f(p_k^\star, \alpha_k^\star) \le f(p_k^*, \alpha_k^*)$. It then follows that
\begin{equation*}
V_k^\star \le f(p_k^\star, \alpha_k^\star) \le f(p_k^*, \alpha_k^*) = V_k^*.
\end{equation*}
Since this applies to any arbitrary producer $k$, $V_k^\star \le V_k^*, \forall k$. Prices and decisions identified by the market operator therefore maximise the expected pay-off of each producer, resulting in a competitive equilibrium.
\end{proof}
\begin{proposition}
(\textcolor{green}{Cost Recovery}) The stochastic market clearing problem produces prices and decisions that guarantee a non-negative expected pay-off for flexible generators.
\end{proposition}
\begin{proof}
It follows from Lemma \ref{ExpectedPayOff} that
\begin{equation*}
V_k^*=  c_k^Q(p_k^* - (\alpha_k^*)^\top \mu)^2 + c_k^Q (\alpha_k^*)^\top \Sigma \alpha_k^* + \overline{\nu}_k^* \overline{p}_k, \forall k.
\end{equation*}
Note that the first two terms are non-negative since $c_k^Q > 0, \forall k$, and $\Sigma \succ 0$ (by assumption). In addition, the third term is non-negative, since $\overline{\nu}_k^* \ge 0$ (dual feasibility) and $\overline{p}_k > 0$ (by assumption). Hence, we have
\begin{equation*}
V_k^* \ge 0, \forall k.
\end{equation*}
In other words, the expected pay-off of flexible generators is non-negative and the cost recovery property is therefore satisfied.
\end{proof}

\begin{proposition}
(\textcolor{green}{Revenue Adequacy}) The stochastic market clearing problem produces prices and decisions guaranteeing that the market operator does not incur any financial loss.
\end{proposition}
\begin{proof}
Let $\{\lambda^*, \{\chi_i^*\}_{\forall i}\}$ and $\{p_k^*, \{\alpha_{ki}^*\}_{\forall i}\}_{\forall k}$ denote prices and decisions calculated by the market operator. Consumers only pay the market operator for the electricity consumed, while flexible generators receive payments covering energy and reserves. Wind producers, on the other hand, are paid for their energy and charged for the variability they introduce into the system. More precisely, if wind producers are paid for their forecast production $\tilde{W}_i$ and charged for their variability via the reserve price $\chi_i$, while flexible generators are paid for their scheduled production $p_k^*$ and contribution to reserve procurement $\{\alpha_{ki}^*\}_{\forall i}$, respectively, the surplus collected by the market operator is as follows,
\begin{align*}
\Delta^* &= \lambda^*D + \sum_i \chi_i^* - \sum_i \lambda^*\tilde{W}_i - \sum_k \lambda^*p_k^* - \sum_k \sum_i \alpha_{ki}^* \chi_i^*\\
&= \lambda^*\big(D - \sum_i \tilde{W}_i - \sum_k p_k^*\big) + \sum_i \chi_i (1 - \sum_k \alpha_{ki}^*)\\
&= 0,
\end{align*}
where the third line follows the fact that the markets for energy and reserves clear (primal feasibility of market clearing problem). Note that this result holds for any forecast error realisation.
\end{proof}

\begin{proposition}
(\textcolor{red}{Incentive Compatibility}) The stochastic market clearing problem does not produce prices and decisions guaranteeing that each flexible generator maximises its pay-off by bidding truthfully.
\end{proposition}
\begin{proof}
By contradiction. Assume that incentive compatibility holds and see counter-example implemented in Julia \cite{SMER2022}, where a producer operating in an electricity market with a finite number of producers can increase its pay-off by bidding untruthfully.
\end{proof}

Market properties are also discussed in \cite{Ratha2019} in a similar set-up. The proofs of incentive compatibility and revenue adequacy seem weird, however. The proof of cost recovery looks weird too (specifically the fact that the dual problem is a linear program, in spite of the fact that the primal problem is a quadratic program). 

\section{Sensitivity Analysis}

In this section, we carry out a sensitivity analysis of the stochastic market clearing problem with respect to two essential statistical parameters, namely the mean $\mu_i$ and standard deviation $\sigma_i$ of the forecast error of wind producer $i$.

\begin{assumption}
We assume throughout this section that $c_k > 0,\phi_k \ge 0, \forall k$, and $\Sigma \succ 0$.
\end{assumption}

Note that selecting $\epsilon_k \in (0, 0.5]$ will guarantee that $\phi_k \ge 0$ if forecast errors are assumed to follow normal distributions. On the other hand, $\phi_k > 0$ always holds for $\epsilon_k \in (0, 1)$ in the distributionally robust setting.

Let $(\{p_k^*\}_{\forall k}, \{\alpha_k^*\}_{\forall k})$ and $(\lambda^*, \chi^*, \{\underline{\nu}_k^*\}_{\forall k}, \{\overline{\nu}_k^*\}_{\forall k})$ denote optimal primal and dual solutions obtained by solving the stochastic market clearing problem. Then, let $V^*: \mathbb{R} \times \mathbb{R}_+ \rightarrow \mathbb{R}$ denote the value function of the stochastic market clearing problem, that is, 
\begin{align*}
V^*(\mu, \sigma) &= \mathbb{E}\Big[\sum_k \big(c_k^L \mathbf{p}_k^{g*}(\{\boldsymbol{\omega}_i\}_{\forall i}) + c_k^Q (\mathbf{p}_k^{g*}(\{\boldsymbol{\omega}_i\}_{\forall i}))^2\big)\Big]\\
 &= \sum_k \Big(c_k^L(p_k^* - (\alpha_k^*)^\top \mu) + c_k^Q \big((p_k^* - (\alpha_k^*)^\top \mu)^2 + (\alpha_k^*)^\top \Sigma \alpha_k^* \big)\Big).
\end{align*}
In the following, we assume that we work with parameters $\mu$ and $\Sigma$ such that the value function can always be defined (i.e., the optimal solution set is non-empty). Before presenting our main result, we prove the following lemma.
\begin{lemma}\label{lemma1}
Let $V^*$ be the value function of the market clearing problem. Then, we have
\begin{align*}
\frac{\partial V^*}{\partial \mu_i} &= \frac{\partial \mathcal{L}^*}{\partial \mu_i},\\
\frac{\partial V^*}{\partial \sigma_i} &= \frac{\partial \mathcal{L}^*}{\partial \sigma_i},
\end{align*}
where right-hand side expressions should be interpreted as the partial derivatives of the Lagrangian function $\mathcal{L}$ (whose expression is given in Appendix A) with respect to $\mu_i$ and $\sigma_i$ evaluated at an optimal solution.
\end{lemma}
\begin{proof}
The proof relies on an enveloppe theorem developed for saddle point and constrained convex programming problems \cite{Milgrom2002}. In essence, this theorem (Theorem 5 and Corollary 5 in \cite{Milgrom2002}) states that if i) the set over which optimisation takes place is convex and compact, ii) the functions defining the objective and constraints are continuous, iii) the derivatives of the functions forming the constraints taken with respect to the parameters are continuous (both in the variables and parameters), iv) some constraint qualification holds (e.g., Slater's condition is satisfied), then the value function is directionally differentiable and can be expressed in terms of the derivative of the Lagrangian function (with respect to parameters). In addition, if the set of optimal solutions corresponding to given parameters is a singleton, the value function is differentiable at these parameters and it is equal to the derivative of the Lagrangian function evaluated at the optimal solution.

First, note that unlike the stochastic market clearing problem, the problem for which the result in \cite{Milgrom2002} was derived does not include any equality constraints. It is nonetheless possible to define an equivalent market clearing formulation featuring only inequality constraints by eliminating equality constraints (e.g., via the QR decomposition of the equality constraint matrix) and optimising directly over the resulting affine space. Note that an affine space is also convex, and a compact subset of the affine space containing the optimal solution associated with given parameters can be considered for our purpose. Hence, the market clearing problem satisfies conditions i), ii), iii) and iv). In particular, it is possible to find feasible solutions strictly satisfying inequality constraints, such that Slater's condition is satisfied. Now, since $c_k^Q > 0, \forall k,$ and $\Sigma \succ 0$, the Hessian of the objective function is positive definite, which in turn implies that the objective of the market clearing problem is strictly convex and the problem therefore has a unique optimal solution. Thus, by virtue of Corollary 5 in \cite{Milgrom2002}, the partial derivatives of the value function with respect to $\mu_i$ and $\sigma_i$ can be expressed as the partial derivatives of the Lagrangian function evaluated at the corresponding optimal solution.
\end{proof}
Next, we have the following result.
\begin{proposition}\label{SensitivityReservePrice}
(Reserve Price as Sensitivity of Expected System Cost to Forecast Error Moments) The reserve price measures the combined sensitivity of the expected system cost with respect to the mean and standard deviation of the forecast error, such that
\begin{equation*}
\chi_i^* = \mu_i \frac{\partial V^*}{\partial \mu_i} + \sigma_i \frac{\partial V^*}{\partial \sigma_i}.
\end{equation*}
\end{proposition}
\begin{proof}
Building upon Lemma \ref{lemma1}, we successively have
\begin{align*}
\frac{\partial V^*}{\partial \mu_i} =& \frac{\partial \mathcal{L}^*}{\partial \mu_i}\\
=& \sum_k \Big(-c_k^L \alpha_{ki}^* + 2 c_k^Q \big(- p_k^* \alpha_{ki}^* + (\alpha_{ki}^*)^2 \mu_i + \sum_{j \ne i} \alpha_{ki}^* \alpha_{kj}^* \mu_j\big) + \underline{\nu}_k^* \alpha_{ki}^* - \overline{\nu}_k^* \alpha_{ki}^*\Big)\\
=& \sum_k \alpha_{ki}^* \Big(-c_k^L + 2 c_k^Q \big(- p_k^* + \alpha_{ki}^* \mu_i + \sum_{j \ne i} \alpha_{kj}^* \mu_j\big) + \underline{\nu}_k^* - \overline{\nu}_k^*\Big)\\
=& \sum_k \alpha_{ki}^* \Big(\frac{\chi_i^*}{\mu_i} - 2 \frac{c_k^Q}{\mu_i}\big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{kj}^*\big)\\
 &- \frac{\phi_k}{\mu_i} \frac{\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j  \alpha_{kj}^*}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big),
\end{align*}
where the first line follows from Lemma \ref{lemma1}, the second line is obtained by taking the partial derivative of the Lagrangian function with respect to $\mu_i$ and evaluating it at the optimal solution, re-arranging terms yields the third line, the fourth line is obtained by substituting the stationarity condition of the Lagrangian function with respect to $\alpha_{ki}$ (satisfied at optimality), while re-arranging terms gives the fifth line. It immediately follows that
\begin{align*}
\mu_i \frac{\partial V^*}{\partial \mu_i} =& \sum_k\alpha_{ki}^*\Big(\chi_i^* - 2 c_k^Q \big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{kj}^*\big)\\
 &- \phi_k \frac{\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j  \alpha_{kj}^*}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big).
\end{align*}
Then, we have
\begin{align*}
\frac{\partial V^*}{\partial \sigma_i} =& \frac{\partial \mathcal{L}^*}{\partial \sigma_i}\\
=& \sum_k \Big(2c_k^Q\big(\sigma_i (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_j \alpha_{ki}^*\alpha_{kj}^*\big)\\
&+ \phi_k \frac{\sigma_i (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_j \alpha_{ki}^*\alpha_{kj}^*}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big)\\
=&\sum_k\frac{\alpha_{ki}^*}{\sigma_i}\Big(2c_k^Q\big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j\alpha_{kj}^*\big)\\
&+ \phi_k \frac{\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{kj}^*}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big),
\end{align*}
where the first line follows from Lemma \ref{lemma1}, the second line is obtained by taking the partial derivative of the Lagrangian function with respect to $\sigma_i$ and evaluating it at the optimal solution, while re-arranging terms yields the third line. In other words, we get
\begin{align*}
\sigma_i \frac{\partial V^*}{\partial \sigma_i} =& \sum_k \alpha_{ki}^*\Big(2c_k^Q\big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j\alpha_{kj}^*\big)\\
&+ \phi_k \frac{\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{kj}^*}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big).
\end{align*}
Combining these two results then yields
\begin{equation*}
\mu_i \frac{\partial V^*}{\partial \mu_i} = \sum_k\alpha_{ki}^* \chi_i^* - \sigma_i \frac{\partial V^*}{\partial \sigma_i}.
\end{equation*}
Since all contributions $\{\alpha_{ki}^*\}_{\forall k}$ to reserves sum to 1, we get the desired result
\begin{equation*}
\mu_i \frac{\partial V^*}{\partial \mu_i} + \sigma_i \frac{\partial V^*}{\partial \sigma_i} = \chi_i^*.
\end{equation*}
\end{proof}
We also have the following result.
\begin{proposition}\label{SensitivityMeanElectricityPrice}
(Sensitivity to Mean Forecast Error) The sensitivity of the expected system cost with respect to the mean forecast error is proportional to the opposite of the electricity price, that is,
\begin{equation*}
\frac{\partial V^*}{\partial \mu_i} = -\lambda^*.
\end{equation*}
\end{proposition}
\begin{proof}
It follows from the proof of Proposition \ref{SensitivityReservePrice} that 
\begin{equation*}
\frac{\partial V^*}{\partial \mu_i} = \sum_k \alpha_{ki}^* \Big(-c_k^L + 2 c_k^Q \big(- p_k^* + \alpha_{ki}^* \mu_i + \sum_{j \ne i} \alpha_{kj}^* \mu_j\big) + \underline{\nu}_k^* - \overline{\nu}_k^*\Big).
\end{equation*}
It is clear from the stationarity of the Lagrangian with respect to $p_k$ that the term in parentheses is equal to $-\lambda^*$. We therefore have
\begin{align*}
\frac{\partial V^*}{\partial \mu_i} &= \sum_k \alpha_{ki}^* (-\lambda^*)\\
&= -\lambda^*,
\end{align*}
since the $\alpha_{ki}^*$ sum to 1 (primal feasibility).
\end{proof}

It follows from this result that a higher mean forecast error for wind farm $i$ effectively decreases the expected system cost, provided that the electricity price $\lambda^*$ is positive. This is typically the case when the marginal generator has a positive generation cost. This proposition can therefore be interpreted as follows. First, note that a positive increment in mean forecast error for wind farm $i$ implies that, on average, more wind power generation is available. The amount of power that should be produced by flexible generators to satisfy the inflexible electricity demand is thus smaller (it decreases by the same amount). Second, recall that wind power generation is assumed to have a zero marginal cost (and does not appear in the objective), while flexible generators are assumed to have a positive marginal cost. Hence, the expected system cost decreases when the mean forecast error of wind farm $i$ increases as a result of the fact that a higher share of the inflexible demand can be satisfied by wind power generation with zero marginal cost.

Next, we investigate the sensitivity of the expected system cost with respect to the standard deviation of the forecast error. We start by briefly reviewing some facts about correlation matrices since the sensitivity of the expected system cost with respect to the standard deviation of individual producers essentially depends on it.

\begin{definition}\label{CorrelationMatrix}
(Correlation Matrix) A correlation matrix is a (symmetric) positive semi-definite matrix with ones on the main diagonal and such that all its entries are between $-1$ and $1$. 
\end{definition}
A couple of key properties can be immediately derived from the definition.
\begin{proposition}
Let $C$ be a $N \times N$ correlation matrix. Then, 
\begin{itemize}
\item[(i)] its eigenvalues sum to $N$.
\item[(ii)] its eigenvalues are comprised between $0$ and $N$.
\item[(iii)] in general, it is not diagonally-dominant.
%\item[(iv)] $C \nsucc 0$ if $\exists C_{ij}, i \ne j$, such that $|C_{ij}| = 1$.
\end{itemize}
\end{proposition}
\begin{proof}The proofs go as follows:
\begin{itemize}
\item[(i)] The sum of the eigenvalues of a matrix is equal to its trace and $\mbox{tr}(C) = N$.
\item[(ii)] The eigenvalues of $C$ are non-negative (since $C$ is positive semi-definite) and sum to $N$. They must therefore be smaller than or equal to $N$. Note that this bound may not be tight.
\item[(iii)] By contradiction. Let us assume that correlation matrices are diagonally-dominant and consider
\begin{equation*}
C = \begin{pmatrix} 1 & -0.8 & -0.3 \\ -0.8 & 1 & -0.3 \\ -0.3 & -0.3 & 1 \end{pmatrix}.
\end{equation*}
This matrix has eigenvalues $\nu_1 \approx 0.0169$, $\nu_2 \approx 1.18$ and $\lambda_3 \approx 1.799$ and clearly satisfies Definition \ref{CorrelationMatrix}. However,
\begin{equation*}
|C_{11}| = 1 < 1.1 = 0.8 + 0.3 = |C_{12}| + |C_{13}|
\end{equation*}
and its is not diagonally-dominant.
%\item[(iv)] By contradiction. Let us assume that $C \succ 0$ and $\exists C_{ij}, |C_{ij}| = 1, i \ne j$. Then, rows $i$ and $j$ will be linearly-dependent (row $j$ can be obtained by multiplying row $i$ by $1$ or $-1$ depending on the sign of $C_{ij}$), which implies that $C$ is rank-deficient and it cannot be positive definite.
\end{itemize}
\end{proof} 

In the application at hand, the correlation matrix $\rho$ is defined through the covariance matrix $\Sigma$ as follows, $\rho = D^{-1} \Sigma D^{-1}$, where $D$ is a diagonal matrix with $D_{ii} = \sigma_i$. It directly follows that $\rho \succ 0$ if $\Sigma \succ 0$ (as assumed throughout this section). This imposes constraints on the cases to which our results apply. In particular, the correlation matrix
\begin{equation*}
\rho = \begin{pmatrix} 1 & -1 \\ -1 & 1 \end{pmatrix},
\end{equation*}
which corresponds to a situation where forecast errors are perfectly negatively correlated, cannot be treated since it is singular. The positive definiteness assumption of the covariance matrix therefore imposes constraints on the structure of the correlation matrix.

Before analysing the sensitivity of the expected system cost with respect to the standard deviation of the forecast error, we need a result pertaining to the way that reserves are allocated across wind farms for a given generator.

%\begin{proposition} (Symmetry of Reserve Allocation)
%For each generator $k$, reserves $\alpha_k^* \in [0, 1]^N$ are allocated in a symmetric fashion, that is,
%\begin{equation*}
%\alpha_{k}^* = \eta_k e,
%\end{equation*}
%for some $\eta_k \in [0, 1]$ such that $\sum_k \eta_k = 1$, and where $e \in \mathbb{R}^N$ denotes the all-ones vector.
%\end{proposition}
%\begin{proof}
%The proof proceeds in two steps. We start by showing that
%\begin{equation*}
%\alpha_k^* = \gamma_k \Sigma^{-1} \Big(\lambda^* \mu + \chi^* \Big),
%\end{equation*}
%for some carefully selected $\gamma_k$. Next, we show that the vector expression on the right-hand side above is a multiple of the all-ones vector $e$, that is,
%\begin{equation*}
%\Sigma^{-1} \Big(\lambda^* \mu + \chi^* \Big) = \beta_k e,
%\end{equation*}
%for some appropriate $\beta_k$, from which the result can be deduced.
%
%First, note that from complementary slackness, $\overline{\nu}_k^* = \underline{\nu}_k^* = 0$ if chance constraints are not tight at the optimum. Next, let us write the stationarity conditions of the Lagrangian with respect to $p_k$ and $\alpha_k$. In vector form, they read
%\begin{align*}
%\frac{\partial \mathcal{L}}{\partial \alpha_k} &= -c_k^L \mu - 2 c_k^Q (p_k^* - (\alpha_k^*)^\top \mu) \mu + 2 c_k^Q \Sigma \alpha_k^* - \chi^* = 0,\\
%\frac{\partial \mathcal{L}}{\partial p_k} &= c_k^L + 2 c_k^Q(p_k^* - (\alpha_k^*)^\top \mu) - \lambda^* = 0,
%\end{align*}
%where terms associated with $\overline{\nu}_k^*$ and $\underline{\nu}_k^*$ do not appear since they are both equal to zero. Then, noting that $((\alpha_k^*)^\top \mu) \mu = (\mu \mu^\top) \alpha_k^*$ and re-arranging terms yields
%\begin{align*}
%&2 c_k^Q (\Sigma + \mu \mu^\top) \alpha_k^* = 2 c_k^Q p_k^* \mu + c_k^L \mu + \chi^*,\\
%& 2c_k^Q p_k^* = 2 c_k^Q (\alpha_k^*)^\top \mu - c_k^L + \lambda^*.
%\end{align*}
%Substituting the left-hand side of the second equation into the right-hand side of the first one leads to
%\begin{align*}
%2 c_k^Q (\Sigma + \mu \mu^\top) \alpha_k^* &= 2 c_k^Q ((\alpha_k^*)^\top \mu) \mu - c_k^L \mu + \lambda^* \mu + c_k^L \mu + \chi^*\\
%&= 2 c_k^Q (\mu \mu^\top) \alpha_k^* + \lambda^* \mu + \chi^*,
%\end{align*}
%from which we get the first intermediate result
%\begin{equation*}
%\alpha_k^* = \frac{1}{2 c_k^Q} \Sigma^{-1} (\lambda^* \mu + \chi^*).
%\end{equation*}
%
%To obtain the second intermediate result, note that reserves must be allocated so that the forecast error from each wind farm must be fully covered. Thus we have that,
%\begin{equation*}
%\sum_k \alpha_k^* = e.
%\end{equation*}
%Substituting the expression for $\alpha_k$ obtained above successively yields
%\begin{align*}
%&\sum_k \alpha_k^* = e\\
%\Leftrightarrow &\sum_k \frac{1}{2 c_k^Q} \Sigma^{-1} (\lambda^* \mu + \chi^*) = e\\
%\Leftrightarrow &\frac{1}{\gamma_k} \Sigma^{-1} (\lambda^* \mu + \chi^*) = e,
%\end{align*}
%where $\gamma_k = (\sum_k 1/2 c_k^Q)^{-1}$, and from which the second intermediate result follows.
%
%Combining the two intermediate results then gives
%\begin{align*}
%\alpha_k^* &= \frac{1}{2 c_k^Q} \Sigma^{-1} (\lambda^* \mu + \chi^*)\\
%&= \frac{1}{2 c_k^Q} \gamma_k e\\
%&= \frac{1}{2 c_k^Q} \bigg(\sum_k \frac{1}{2 c_k^Q}\bigg)^{-1} e,
%\end{align*}
%and defining
%\begin{equation*}
%\eta_k = \frac{1}{2 c_k^Q} \bigg(\sum_k \frac{1}{2 c_k^Q}\bigg)^{-1}
%\end{equation*}
%yields the desired result. It is simple to check that $\sum_k \eta_k = 1$, as expected.
%\end{proof}

\begin{proposition}\label{ReserveAllocation}
(Symmetry of Reserve Allocation) For each generator $k$, reserves $\alpha_k^* \in [0, 1]^N$ are allocated symmetrically across wind farms, that is,
\begin{equation*}
\alpha_{k}^* = \eta_k e,
\end{equation*}
for some $\eta_k \in [0, 1]$ such that $\sum_k \eta_k = 1$, and where $e \in \mathbb{R}^N$ denotes the all-ones vector.
\end{proposition}
\begin{proof}
The proof proceeds in two steps. We start by showing that the optimal reserve allocation of generator $k$ can be expressed as
\begin{equation*}
\alpha_k = \gamma_k \Sigma^{-1} \Big(\lambda \mu + \chi \Big),
\end{equation*}
for some carefully selected $\gamma_k$ and where the star superscript was omitted for clarity (we keep this convention throughout the proof). Next, we show that the vector expression on the right-hand side above is a multiple of the all-ones vector $e$, that is,
\begin{equation*}
\Sigma^{-1} \Big(\lambda \mu + \chi \Big) = \beta_k e,
\end{equation*}
for some appropriate $\beta_k$, from which the main result can be deduced.

To simplify the first part of the proof, we work with an updated problem formulation in which chance constraints are re-written as
\begin{align*}
\phi_k^2 \alpha_k^\top \Sigma \alpha_k &\le (\overline{p}_k - p_k + \alpha_k^\top \mu)^2,\\
\phi_k^2 \alpha_k^\top \Sigma \alpha_k &\le (p_k - \alpha_k^\top \mu)^2,
\end{align*}
with Lagrangian dual variables $\overline{\upsilon}_k$ and $\underline{\upsilon}_k$, respectively. Note that this formulation is equivalent to the original one, since applying a strictly increasing function (i.e., taking the square) on both sides of an inequality constraint does not change the feasible set. Hence, a primal solution that is optimal for the updated problem will also be optimal for the original problem and vice-versa. If the constraints are tight, however, $\overline{\upsilon}_k \ne \overline{\nu}_k$ and $\underline{\upsilon}_k \ne \underline{\nu}_k$. We now write the Lagrangian function of this updated problem and analyse its first-order optimality conditions. The updated Lagrangian function $\hat{\mathcal{L}}$ reads
\begin{align*}
\hat{\mathcal{L}}(\{p_k\}, \{\alpha_k\}, \lambda, \chi, \{\overline{\upsilon}_k\}, \{\underline{\upsilon}_k\}) &= \sum_k \Big(c_k^L(p_k - \alpha_k^\top \mu) + c_k^Q \big((p_k - \alpha_k^\top \mu)^2 + \alpha_k^\top \Sigma \alpha_k\big)\Big)\\
&+ \sum_k \underline{\upsilon}_k \big(\phi_k^2 \alpha_k^\top \Sigma \alpha_k - (p_k - \alpha_k^\top \mu)^2\big)\\
&+ \sum_k \overline{\upsilon}_k \big(\phi_k^2 \alpha_k^\top \Sigma \alpha_k - (\overline{p}_k - p_k + \alpha_k^\top \mu)^2\big)\\
&+ \lambda \Big(D - \sum_k p_k - W^\top e\Big) + \chi^\top \Big(e - \sum_k \alpha_{k}\Big).
\end{align*}
Then, in matrix form, the stationarity conditions of the updated Lagrangian with respect to $p_k$ and $\alpha_k$ read
\begin{align*}
\frac{\partial \hat{\mathcal{L}}}{\partial p_k} =& c_k^L + 2 c_k^Q(p_k - \alpha_k^\top \mu) - 2 \underline{\upsilon}_k(p_k - \alpha_k^\top \mu) + 2 \overline{\upsilon}_k (\overline{p}_k - p_k + \alpha_k^\top \mu) - \lambda = 0,\\
\frac{\partial \hat{\mathcal{L}}}{\partial \alpha_k} =& -c_k^L \mu - 2 c_k^Q (p_k - \alpha_k^\top \mu) \mu + 2 c_k^Q \Sigma \alpha_k + 2 \underline{\upsilon} \phi_k^2 \Sigma \alpha_k - 2 \underline{\upsilon}_k (p_k - \alpha_k^\top \mu)(-\mu),\\
&+ 2 \overline{\upsilon}_k \phi_k^2 \Sigma \alpha_k - 2 \overline{\upsilon}_k (\overline{p}_k - p_k + \alpha_k^\top \mu) \mu - \chi = 0.
\end{align*}
The first equation can be re-written as
\begin{equation*}
2c_k^Q p_k - 2 \underline{\upsilon}_k p_k + 2 \overline{\upsilon}_k \overline{p}_k - 2 \overline{\upsilon}_k p_k = -c_k^L + 2 c_k^Q \alpha_k^\top \mu - 2 \underline{\upsilon}_k \alpha_k^\top \mu - 2 \overline{\upsilon}_k \alpha_k^\top \mu + \lambda.
\end{equation*}
Noting that $(\alpha_k^\top \mu) \mu = (\mu \mu^\top) \alpha_k$ and re-arranging terms, the second equation can be re-written as
\begin{align*}
\bigg[2 \Big(c_k^Q - \underline{\upsilon}_k - \overline{\upsilon}_k\Big)& \mu \mu^\top + 2\Big(c_k^Q + \underline{\upsilon}_k \phi_k^2 + \overline{\upsilon}_k \phi_k^2\Big) \Sigma \bigg]\alpha_k\\
&= \big(2c_k^Q p_k - 2 \underline{\upsilon}_k p_k + 2 \overline{\upsilon}_k \overline{p}_k - 2 \overline{\upsilon}_k p_k\big) \mu + c_k^L \mu + \chi.
\end{align*}
Substituting the left-hand side of the first equation into the right-hand side of the second equation then yields
\begin{align*}
\bigg[2 \Big(c_k^Q -& \underline{\upsilon}_k - \overline{\upsilon}_k\Big) \mu \mu^\top + 2\Big(c_k^Q + \underline{\upsilon}_k \phi_k^2 + \overline{\upsilon}_k \phi_k^2\Big) \Sigma \bigg]\alpha_k\\
&= -c_k^L \mu + 2 c_k^Q \mu \mu^\top \alpha_k - 2 \underline{\upsilon}_k \mu \mu^\top \alpha_k - 2 \overline{\upsilon}_k \mu \mu^\top \alpha_k + \lambda \mu + c_k^L \mu + \chi.
\end{align*}
Cancelling terms out on both sides then leads to
\begin{equation*}
\bigg[2\Big(c_k^Q + \underline{\upsilon}_k \phi_k^2 + \overline{\upsilon}_k \phi_k^2\Big) \bigg] \Sigma \alpha_k = \lambda \mu + \chi.
\end{equation*}
Defining 
\begin{equation*}
\gamma_k = \bigg[2\Big(c_k^Q + \underline{\upsilon}_k \phi_k^2 + \overline{\upsilon}_k \phi_k^2\Big) \bigg]^{-1}
\end{equation*}
and multiplying both sides by $\Sigma^{-1}$ and $\gamma_k$ yields the first intermediate result. 

To obtain the second intermediate result, note that reserves must be allocated so that the forecast error from each wind farm is fully covered. Thus, we have
\begin{equation*}
\sum_k \alpha_k = e.
\end{equation*}
Substituting the expression for $\alpha_k$ obtained above yields
\begin{equation*}
\sum_k \gamma_k \Sigma^{-1} (\lambda \mu + \chi) = e.
\end{equation*}
The second intermediate result then follows from defining
\begin{equation*}
\beta_k = \bigg[\sum_k \gamma_k\bigg]^{-1}
\end{equation*}
and multiplying both sides by $\beta_k$.

Combining the two intermediate results then gives
\begin{align*}
\alpha_k &= \gamma_k \Sigma^{-1} (\lambda \mu + \chi)\\
&= \gamma_k \beta_k e,
\end{align*}
such that defining
\begin{equation*}
\eta_k = \gamma_k \beta_k =  \gamma_k \bigg(\sum_k \gamma_k\bigg)^{-1}
\end{equation*}
leads to the desired result. It is simple to check that $\sum_k \eta_k = 1$, as expected.
\end{proof}

We can now derive the main result.

\begin{proposition}\label{SensitivityStandardDeviation}
(Sensitivity to Standard Deviation of Forecast Error) The sensitivity of the expected system cost with respect to the standard deviation of forecast errors depends on their correlation structure. More precisely, we have:
\begin{itemize}
\item[(i)] If forecast errors are independent, the sensitivity with respect to $\sigma_i$ is always positive, that is, 
\begin{equation*}
\frac{\partial V^*}{\partial \sigma_i} > 0.
\end{equation*}
\item[(ii)] If forecast errors are positively correlated, the sensitivity with respect to $\sigma_i$ is always positive.
\item[(iii)] In general, the sign of the sensitivity with respect to $\sigma_i$ is given by the sign of the expression
\begin{equation*}
\sigma_i +\sum_{j \ne i} \rho_{ij} \sigma_j.
\end{equation*}
\end{itemize}
\end{proposition}
\begin{proof} In order to prove these results, we start by deriving an expression for the sensitivity with respect to the standard deviation of the forecast error. Notably, it follows from the proof of Proposition \ref{SensitivityReservePrice} that
\begin{align*}
\frac{\partial V^*}{\partial \sigma_i} =& \sum_k\alpha_{ki}^*\Big(2c_k^Q\big(\sigma_i \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_j\alpha_{kj}^*\big)\\
&+ \phi_k \frac{\sigma_i \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_j \alpha_{kj}^*}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big)\\
&=  \sum_k \alpha_{ki}^* \Big(\sigma_i \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_j\alpha_{kj}^*\Big)\Big(2c_k^Q + \frac{\phi_k}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big)\\
&= \sum_k \varphi_k \alpha_{ki}^* \Big(\sigma_i \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_j\alpha_{kj}^*\Big),
\end{align*}
where we defined
\begin{equation*}
\varphi_k = 2c_k^Q + \frac{\phi_k}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)
\end{equation*}
for brevity. Note that $\underline{\nu}_k^* \ge 0$, $\overline{\nu}_k^* \ge 0$ and $||\alpha_k^*||_{\Sigma} \ge 0$, $\forall k$. In addition, by Assumption \ref{StrictConvexity}, $c_k^Q > 0$ and $\phi_k \ge 0, \forall k$. Thus, $\varphi_k \ge 0, \forall k$. By virtue of Proposition \ref{ReserveAllocation}, $\alpha_k = \eta_k e$ for some $\eta_k \in [0, 1]$, which implies that $\alpha_{ki} = \alpha_{kj} = \eta_k$ for all $i$ and $j$. The sensitivity with respect to $\sigma_i$ can therefore be re-written as
\begin{equation*}
\frac{\partial V^*}{\partial \sigma_i} = \bigg(\sigma_i + \sum_{j \ne i} \rho_{ij} \sigma_j \bigg)\sum_k \varphi_k \eta_k^2.
\end{equation*}
Since the second term is itself a sum of non-negative terms, the sign of the sensitivity essentially depends on the sign of the expression in parentheses, for which we use the shorthand notation
\begin{equation*}
v_{i}(\rho) = \sigma_i + \sum_{j \ne i} \rho_{ij} \sigma_j,
\end{equation*}
with $v_{i}: \mathcal{K} \rightarrow \mathbb{R}$ and $\mathcal{K} = \{A \in \mathbb{R}^{N \times N}: -1 \le A_{mn} \le 1, m \ne n, A_{nn} = 1, A \succeq 0\}$ the set of $N \times N$ correlation matrices. Next, the analysis focuses on the sign of $v_i$ under different assumptions on the structure of the correlation matrix $\rho$.
\begin{itemize}
\item[(i)] If forecast errors are independent, $\rho_{ij} = 0, i \ne j$. Hence, we have
\begin{equation*}
v_{i}(\rho) = \sigma_i > 0.
\end{equation*}
\item[(ii)] If forecast errors are positively correlated, $\rho_{ij} \ge 0, i \ne j$. It directly follows from its definition that 
\begin{equation*}
v_{i}(\rho) > 0.
\end{equation*}
\item[(iii)] The result is clear from the expression of the sensitivity derived above.
\end{itemize}
This concludes the proof.
\end{proof}

Finally, we analyse the sign of reserve payments made to flexible producers based on sensitivity results obtained above. We start with a result pertaining to what we term the \textit{combined sensitivity of expected system cost to standard deviation}.

\begin{lemma}\label{SensitivityTotalStandardDeviation}
(Combined Sensitivity to Standard Deviation of Forecast Error) The combined sensitivity of expected system cost with respect to the standard deviation of the forecast error is non-negative, that is, 
\begin{equation*}
\sum_i \sigma_i \frac{\partial V^*}{\partial \sigma_i} \ge 0.
\end{equation*}
\end{lemma}
\begin{proof}
It follows from the proof of Proposition \ref{SensitivityReservePrice} that
\begin{align*}
\sigma_i \frac{\partial V^*}{\partial \sigma_i} =& \sum_k\alpha_{ki}^*\Big(2c_k^Q\big(\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j\alpha_{kj}^*\big)\\
&+ \phi_k \frac{\sigma_i^2 \alpha_{ki}^* + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{kj}^*}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big)\\
=&  \sum_k\Big(\sigma_i^2 (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j\alpha_{ki}^* \alpha_{kj}^*\Big)\Big(2c_k^Q + \frac{\phi_k}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big).
\end{align*}
Thus, we can write
\begin{align*}
\sum_i \sigma_i \frac{\partial V^*}{\partial \sigma_i} =& \sum_i \sum_k \Big(\sigma_i^2 (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j\alpha_{ki}^* \alpha_{kj}^*\Big) \Big(2c_k^Q + \frac{\phi_k}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big)\\
=& \sum_k \Big(2c_k^Q + \frac{\phi_k}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big) \sum_i \Big(\sigma_i^2 (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j\alpha_{ki}^* \alpha_{kj}^*\Big)\\
=& \sum_k \Big(2c_k^Q + \frac{\phi_k}{||\alpha_k^*||_{\Sigma}}(\underline{\nu}_k^* + \overline{\nu}_k^*)\Big) \times(\alpha_k^*)^\top \Sigma \alpha_k^*\\
=& \sum_k ||\alpha_k^*||_{\Sigma} \Big(2c_k^Q ||\alpha_k^*||_{\Sigma} + \phi_k (\underline{\nu}_k^* + \overline{\nu}_k^*)\Big).
\end{align*}
Note that $\underline{\nu}_k^* \ge 0$, $\overline{\nu}_k^* \ge 0$, $\forall k$. Clearly, $||\alpha_k^*||_{\Sigma} \ge 0, \forall k$. In addition, by Assumption \ref{StrictConvexity}, $c_k^Q > 0$ and $\phi_k \ge 0, \forall k$. Hence, each term in the sum is non-negative and the result follows.
\end{proof}

\begin{proposition}
(Sign of Reserve Payment to Flexible Generators) The sign of payments made to flexible generator $k$ for reserves depends on the expression
\begin{equation*}
-\lambda e^\top \mu + \vartheta_k e^\top \Sigma e,
\end{equation*}
where $\vartheta_k \ge 0$ depends on the quadratic cost component, the risk parameter and dual variables of chance constraints. In the particular case that chance constraints are not tight, its expression simplifies to
\begin{equation*}
\vartheta_k = \bigg[\sum_k \frac{1}{2 c_k^Q} \bigg]^{-1}.
\end{equation*} 
\end{proposition}
\begin{proof}
The payment received by generator $k$ for reserves can be written as follows
\begin{equation*}
\alpha_k^\top \chi = \sum_i \alpha_{ki} \chi_i,
\end{equation*}
where we omitted the star symbols for clarity. By virtue of Proposition \ref{reserveallocation}, $\alpha_k = \eta_k e$ for some $\eta_k \in [0, 1]$, which implies that $\alpha_{ki} = \alpha_{kj} = \eta_k$ for all $i$ and $j$. In addition, Proposition \ref{SensitivityReservePrice} provides an expression for $\chi_i$, which leads to
\begin{equation*}
\alpha_k^\top \chi = \eta_k \sum_i \bigg(\mu_i \frac{\partial V^*}{\partial \mu_i} + \sigma_i \frac{\partial V^*}{\partial \sigma_i}\bigg).
\end{equation*}
Proposition \ref{SensitivityMeanElectricityPrice} provides an expression for the sensitivity with respect to $\mu_i$, such that
\begin{equation*}
\alpha_k^\top \chi = \eta_k \bigg(-\lambda \sum_i \mu_i + \sum_i \sigma_i \frac{\partial V^*}{\partial \sigma_i}\bigg).
\end{equation*}
Based on the proof of Proposition \ref{SensitivityStandardDeviation}, it is easy to see that
\begin{equation*}
\sum_i \sigma_i \frac{\partial V^*}{\partial \sigma_i} = \sum_k \varphi_k \eta_k^2 \sum_i\Big(\sigma_i^2 + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_k\Big) = \vartheta_k e^\top \Sigma e,
\end{equation*}
where $\vartheta_k = \sum_k \varphi_k \eta_k^2 \ge 0$. The payment for reserves thus becomes
\begin{equation*}
\alpha_k^\top \chi = \eta_k \Big(-\lambda e^\top \mu + \vartheta_k e^\top \Sigma e\Big).
\end{equation*}
When chance constraints are not tight, the expression of $\vartheta_k$ is relatively simple to derive from the expressions of $\eta_k$ (given in Proposition \ref{ReserveAllocation}) and $\varphi_k$ (given in Proposition \ref{SensitivityStandardDeviation}).
\end{proof}

\begin{corollary}
Reserve payments to generator $k$ will always be non-negative if the aggregate mean forecast error is negative (i.e., $e^\top \mu \le 0$).
\end{corollary}
\begin{proof}
In the current setting, $\lambda \ge 0$ since all generating units non-negative marginal costs. Furthermore, $\eta_k \ge 0$, $\vartheta_k \ge 0$ and $e^\top \Sigma e > 0$ (as $\Sigma \succ 0$). It follows that $\alpha_k^\top \chi \ge 0$.
\end{proof}

%\paragraph{Comments} I am not sure that such a result holds for each individual wind producer $i$ in general. To prove it, we would basically need to show that $\sigma_i^2 (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{ki}^* \alpha_{kj}^* \ge 0, \forall k$. For particular cases, it is pretty simple. For instance, the result obviously holds for individual producers if forecast errors are independent (the sum over $j$ is then equal to 0). Likewise, the result trivially holds if all forecast errors are positively correlated. In the general case, however, this will probably depend on the sign of the correlation between forecast errors.

\section{Numerical Experiments}

\subsection{Three Generators \& Two Wind Farms}

We analyse a system with three flexible generators ($K = 3$) and two wind farms ($N = 2$), which is implemented in \cite{SMER2022}. 

\paragraph{Symmetric Forecast Errors} We consider a configuration where $\mu_1 = \mu_2 = 0$, $\sigma_1 = \sigma_2 = \sigma > 0$ and $\rho_{12} = \rho < 0$ (i.e., the forecast errors of wind farms are negatively correlated). It was consistently observed in experiments that $\alpha_{k1}^* = \alpha_{k2}^*, k = 1, \ldots, 3,$ in the optimal solution, which is in line with Proposition \ref{ReserveAllocation}. It follows that
\begin{align*}
\sigma_i^2 (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{ki}^* \alpha_{kj}^* &= \sigma^2 (\alpha_{ki}^*)^2 + \rho \sigma^2 (\alpha_{ki}^*)^2\\
&= \sigma^2 (\alpha_{ki}^*)^2 \big(1 + \rho\big)\\
&\ge 0,
\end{align*}
since $\sigma > 0$, $\alpha_{ki}^* > 0$ and $|\rho| \le 1$. Note that these developments are valid for $k = 1, \ldots, 3$, which implies that 
\begin{equation*}
\sigma_i \frac{\partial V^*}{\partial \sigma_i} \ge 0, i = 1, \ldots, 2.
\end{equation*}
In other words, the expected system cost increases with the standard deviation of any wind farm. Note that reserve prices corresponding to different wind farms are symmetric (and both positive) in this set-up.

\paragraph{Asymmetric Forecast Errors} We consider a configuration where $\mu_1 = \mu_2 = 0$, $\sigma_1 \ne \sigma_2$, $\sigma_1 > 0, \sigma_2 > 0$ and $\rho_{12} = \rho < 0$ (i.e., the forecast errors of wind farms are negatively correlated). More precisely, we assume that $\rho = -0.75$, $\sigma_1 = 0.01 \bar{p}^w$ and $\sigma_2 = 0.025 \bar{p}^w$, where $\bar{p}^w$ denotes the maximum wind generation from each wind farm. In other words, the standard deviations of both farms are equal to 1\% and 2.5\% of their rated capacity, respectively. It can be observed in experiments that $\alpha_{k1}^* = \alpha_{k2}^*, k = 1, \ldots, 3,$ in the optimal solution, which is again consistent with Proposition \ref{ReserveAllocation}. It follows that one of the sensitivities is negative, while the other is positive. Indeed, we have
\begin{equation*}
\sigma_i^2 (\alpha_{ki}^*)^2 + \sum_{j \ne i} \rho_{ij} \sigma_i \sigma_j \alpha_{ki}^* \alpha_{kj}^* = \sigma_i (\alpha_{ki}^*)^2 \big( \sigma_i + \rho \sigma_j \big),
\end{equation*}
and it follows that
\begin{align*}
\sigma_1 + \rho \sigma_2 &= -2.1875 < 0,\\
\sigma_2 + \rho \sigma_1 &= 4.375 > 0.
\end{align*}
Thus, 
\begin{equation*}
\frac{\partial V^*}{\partial \sigma_1} < 0 \mbox{ and } \frac{\partial V^*}{\partial \sigma_2} > 0.
\end{equation*}
Since standard deviations are positive, these observations are also consistent with the fact that the reserve prices associated with wind farm 1 and 2 are negative and positive, respectively. Note that such an outcome will always occur unless $\rho$ is such that the following conditions are satisfied simultaneously, 
\begin{equation*}
\rho \ge -\frac{\sigma_1}{\sigma_2} \mbox{ and } \rho \ge -\frac{\sigma_1}{\sigma_2}.
\end{equation*}
If $\sigma_1 = \sigma_2$ (the symmetric case), this condition is always satisfied, which is consistent with our previous analysis. In the asymmetric case with finite standard deviations, one of these ratios will always be strictly between 0 and 1, while the other will always be strictly greater than 1. The former then defines the range of $\rho$ for which sensitivities remain non-negative. In the case at hand, $\sigma_1/\sigma_2 = 0.4$ and $\rho = -0.75 < -0.4$. The condition above is therefore violated. It is straightforward to check that setting $\rho = -0.4$ yields
\begin{equation*}
\frac{\partial V^*}{\partial \sigma_1} \approx 0 \mbox{ and } \frac{\partial V^*}{\partial \sigma_2} > 0.
\end{equation*}
In summary, the sign of sensitivities depends upon the ratio between standard deviations. In cases with a pronounced asymmetry in standard deviations, negative sensitivities and reserve prices may therefore occur.

\section*{Appendix A}
This section derives complementarity problems based on the KKT conditions of the deterministic equivalent of the equilibrium and market problems and shows that they are identical.

\subsection*{Equilibrium Problem}
To ease the writing of KKT conditions, the problem faced by producer $k$ is first re-written as a minimisation problem,
\begin{align}
-\underset{p_k, \{\alpha_{ki}\}_{\forall i}}{\min} \hspace{10pt} &  c_k^L\big(p_k - \alpha_k^\top \mu\big) + c_k^Q \Big(\big(p_k - \alpha_{k}^\top \mu \big)^2 + \alpha_k^\top \Sigma \alpha_k\Big) - \lambda p_k - \alpha_k^\top \chi\\
\mbox{s.t. } & p_k \le \overline{p}_k + \alpha_k^\top \mu - ||\alpha_k||_{\Sigma} \phi_k, \hspace{25pt} (\overline{\nu}_k)\\
& \alpha_k^\top \mu + ||\alpha_k||_{\Sigma}\phi_k \le p_k, \hspace{48pt}(\underline{\nu}_k)\\
& 0 \le \alpha_{ki} \le 1, \forall i,\\
& p_k \in \mathbb{R}.
\end{align}
Then, the Lagrangian function of producer $k$ can be expressed as
\begin{align*}
\mathcal{L}_k(p_k, \alpha_k, \lambda, \chi, \underline{\nu}_k, \overline{\nu}_k) =& c_k^L(p_k - \alpha_k^\top \mu) + c_k^Q \big((p_k - \alpha_k^\top \mu)^2 + \alpha_k^\top \Sigma \alpha_k\big)\\
&- \lambda p_k - \alpha_k^\top \chi + \underline{\nu}_k(\alpha_k^\top \mu + ||\alpha_k||_{\Sigma} \phi_k - p_k)\\
&+ \overline{\nu}_k (p_k - \overline{p}_k - \alpha_k^\top \mu + ||\alpha_k||_{\Sigma} \phi_k).
\end{align*}
The KKT conditions of the problem faced by producer $k$ now follow
\begin{align*}
\frac{\partial \mathcal{L}_k}{\partial p_k} =& c_k^L + 2 c_k^Q (p_k - \alpha_k^\top \mu) - \lambda - \underline{\nu}_k + \overline{\nu}_k = 0, \forall k,\\
\frac{\partial \mathcal{L}_k}{\partial \alpha_{ki}} =& - c_k^L \mu_i + 2 c_k^Q\Big(- p_k \mu_i + \alpha_{ki}\mu_i^2 + \sum_{j \ne i} \alpha_{kj} \mu_i \mu_j + \sigma_i^2 \alpha_{ki} + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}\Big) \\
&- \chi_i + \underline{\nu}_k \Big(\mu_i + \phi_k \frac{\sigma_i^2 \alpha_{ki} + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}}{||\alpha_k||_{\Sigma}}\Big)\\
&+ \overline{\nu}_k \Big(-\mu_i + \phi_k \frac{\sigma_i^2 \alpha_{ki} + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}}{||\alpha_k||_{\Sigma}}\Big) = 0, \forall k, \forall i,\\
0 \le \overline{\nu}_k &\perp \overline{p}_k + \alpha_k^\top \mu - ||\alpha_k||_{\Sigma} \phi_k - p_k \ge 0,\\
0 \le \underline{\nu}_k & \perp p_k - \alpha_k^\top \mu - ||\alpha_k||_{\Sigma}\phi_k \ge 0,
\end{align*}
where the range constraints of $\alpha_{ki}$ variables were omitted for conciseness. Gathering the KKT conditions of each producer and adding the market clearing constraints yields the complementarity problem associated with the equilibrium problem.

\subsection*{Stochastic Market Clearing Problem}
For simplicity, let 
\begin{align*}
x &= \begin{pmatrix} \{p_k\}_{\forall k}, \{\alpha_k\}_{\forall k} \end{pmatrix}^\top,\\
\pi &= \begin{pmatrix} \lambda, \chi, \{\underline{\nu}_k\}_{\forall k}, \{\overline{\nu}_k\}_{\forall k} \end{pmatrix}^\top,
\end{align*}
denote the set of primal and dual variables, respectively. Let us form the Lagrangian function of the stochastic market clearing problem:
\begin{align*}
\mathcal{L}(x, \pi) =& \sum_k \Big(c_k^L(p_k - \alpha_k^\top \mu) + c_k^Q \big((p_k - \alpha_k^\top \mu)^2 + \alpha_k^\top \Sigma \alpha_k\big)\Big)\\
&+ \sum_k \underline{\nu}_k(\alpha_k^\top \mu + ||\alpha_k||_{\Sigma} \phi_k - p_k)\\
&+ \sum_k \overline{\nu}_k (p_k - \overline{p}_k - \alpha_k^\top \mu + ||\alpha_k||_{\Sigma} \phi_k)\\
&+ \lambda\big(D - \sum_k p_k - \sum_i \tilde{W}_i\big) + \sum_i \chi_i \big(1 - \sum_k \alpha_{ki}\big).
\end{align*}
The KKT conditions associated with the stochastic market clearing problem therefore read
\begin{align*}
\frac{\partial \mathcal{L}}{\partial p_k} =& c_k^L + 2 c_k^Q (p_k - \alpha_k^\top \mu) - \underline{\nu}_k + \overline{\nu}_k - \lambda = 0, \forall k,\\
\frac{\partial \mathcal{L}}{\partial \alpha_{ki}} =& - c_k^L \mu_i + 2 c_k^Q\Big(- p_k \mu_i + \alpha_{ki} \mu_i^2 + \sum_{j \ne i} \alpha_{kj} \mu_i \mu_j + \sigma_i^2 \alpha_{ki} + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}\Big)\\
&+ \underline{\nu}_k \Big(\mu_i + \phi_k \frac{\sigma_i^2 \alpha_{ki} + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}}{||\alpha_k||_{\Sigma}}\Big)\\
&+ \overline{\nu}_k \Big(-\mu_i + \phi_k \frac{\sigma_i^2 \alpha_{ki} + \sum_{j \ne i} \kappa_{ij} \alpha_{kj}}{||\alpha_k||_{\Sigma}}\Big) - \chi_i = 0, \forall k, \forall i,\\
\sum_k p_k +& \sum_i \tilde{W}_i = D,\\
\sum_k \alpha_{ki} &= 1, \forall i,\\
0 \le \overline{\nu}_k &\perp \overline{p}_k + \alpha_k^\top \mu - ||\alpha_k||_{\Sigma} \phi_k - p_k \ge 0, \forall k,\\
0 \le \underline{\nu}_k & \perp p_k - \alpha_k^\top \mu - ||\alpha_k||_{\Sigma}\phi_k \ge 0, \forall k,
\end{align*}
from which the range constraints of $\alpha_{ki}$ variables were omitted for conciseness. Since the objective function is convex, the functions forming the constraints are continuously differentiable and the problem satisfies Slater's condition, the KKT conditions are necessary and sufficient. Thus, a solution to the complementarity problem gives a (globally) optimal solution of the market clearing problem. In addition, since the objective is strongly convex and the feasible set is convex (and non-empty), there is also a unique optimal solution to the problem.

\bibliographystyle{plain} % We choose the "plain" reference style
\bibliography{references}

\end{document}